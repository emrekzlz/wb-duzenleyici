class WBBaslikDuzenleyici {
  constructor(options = {}) {
    // ✅ GENEL AYARLAR (dataset’e bağlı değil)
    this.opts = {
      maxLen: 60,
      includeQuantity: false,   // ✅ Yeşil liste standardı: adet yazma
      sentenceCase: true,       // ilk harf büyük, devamı küçük
      moveLeadingFeatures: true,// "Круглый вырез ..." -> sona taşı
      ...options
    };

    // Tekil/yapay hedef kitle ifadeleri -> для ...
    // (Çoğul "Женские/Мужские" DOKUNMA: bazı listelerde doğru kalıyor)
    this.hedefKitleDonusumleri = [
      { pattern: /\bЖенщина\b/gi, replacement: "для женщин" },
      { pattern: /\bМужчина\b/gi, replacement: "для мужчин" },
      { pattern: /\bДевушка\b/gi, replacement: "для женщин" },
      { pattern: /\bДевочка\b/gi, replacement: "для девочек" },
      { pattern: /\bМальчик\b/gi, replacement: "для мальчиков" },

      { pattern: /\bЖенский\b/gi, replacement: "для женщин" },
      { pattern: /\bЖенская\b/gi, replacement: "для женщин" },
      { pattern: /\bЖенское\b/gi, replacement: "для женщин" },

      { pattern: /\bМужской\b/gi, replacement: "для мужчин" },
      { pattern: /\bМужская\b/gi, replacement: "для мужчин" },
      { pattern: /\bМужское\b/gi, replacement: "для мужчин" },
    ];

    // Basit çoğul->tekil dönüşümler (genel; istisnalarla)
    this.cogulTekilDonusumleri = [
      { pattern: /\bСвитшоты\b/g, replacement: "Свитшот" },
      { pattern: /\bсвитшоты\b/g, replacement: "свитшот" },
      { pattern: /\bСвитеры\b/g, replacement: "Свитер" },
      { pattern: /\bсвитеры\b/g, replacement: "свитер" },
      { pattern: /\bПлатья\b/g, replacement: "Платье" },
      { pattern: /\bплатья\b/g, replacement: "платье" },
      { pattern: /\bБлузки\b/g, replacement: "Блузка" },
      { pattern: /\bблузки\b/g, replacement: "блузка" },
      { pattern: /\bРубашки\b/g, replacement: "Рубашка" },
      { pattern: /\bрубашки\b/g, replacement: "рубашка" },
      { pattern: /\bФутболки\b/g, replacement: "Футболка" },
      { pattern: /\bфутболки\b/g, replacement: "футболка" },
      { pattern: /\bКомбинезоны\b/g, replacement: "Комбинезон" },
      { pattern: /\bкомбинезоны\b/g, replacement: "комбинезон" },
      { pattern: /\bКомплекты\b/g, replacement: "Комплект" },
      { pattern: /\bкомплекты\b/g, replacement: "комплект" },
    ];

    // Çoğul istisnalar (genel ayakkabı/alt giyim gibi)
    this.cogulIstisnalar = [
      "Кроссовки","кроссовки","Сандалии","сандалии","Ботинки","ботинки","Сапоги","сапоги",
      "Туфли","туфли","Кеды","кеды","Тапочки","тапочки","Пинетки","пинетки",
      "Трусы","трусы","Брюки","брюки","Джинсы","джинсы","Шорты","шорты","Очки","очки",
      "Пальто","пальто" // bazen plural/singular karışır; dokunmamak daha güvenli
    ];

    // Sonda kalınca kötü duran bağlaç/edatlar
    this.yasakSonKelimeler = [
      "с","со","из","от","до","без","для","к","ко","о","об","обо","у","в","во","на","за","по","под","над",
      "и","или","а","но","что","как"
    ];

    // Ürün tipi listesi (sıra düzeltme için)
    this.urunTipleri = [
      "Комбинезон","Футболка","Блузка","Рубашка","Свитшот","Джоггеры","Брюки","Шорты","Платье","Юбка",
      "Купальник","Пижамный комплект","Комплект","Трусы","Бюстгальтер","Пальто","Кроссовки","Сандалии",
      "Ботинки","Сапоги","Туфли","Пинетки","Носки","Леггинсы","Кардиган","Толстовка","Куртка","Парка",
      "Жилет","Лоферы","Балетки"
    ];

    // Baştaki bazı özellikleri sona taşıma
    this.onOzellikMap = [
      { re: /^Круглый вырез\b/i, tail: "с круглым вырезом" },
      { re: /^V-образный вырез\b/i, tail: "с V вырезом" },
      { re: /^V-образным вырезом\b/i, tail: "с V вырезом" },
      { re: /^Воротник-стойка\b/i, tail: "с воротником стойкой" },
      { re: /^Квадратный вырез\b/i, tail: "с квадратным вырезом" },
    ];
  }

  // --- Temizleme ---
  boslukDuzelt(t){ return t.replace(/\s+/g," ").trim(); }

  noktalamaTemizle(t){
    return t
      .replace(/\s*:\s*/g," ")
      .replace(/\s*[–—]\s*/g," ")
      .replace(/\s+-\s+/g," ")
      .replace(/\s*,\s*/g,", ")
      .replace(/,\s*,/g,",")
      .replace(/\s*\(\s*/g," (")
      .replace(/\s*\)\s*/g,") ")
      .replace(/\s+/g," ")
      .trim();
  }

  sonNoktalamaTemizle(t){
    return t.replace(/[,\.;:\-–—]+$/g,"").trim();
  }

  sonYasakKelimeTemizle(t){
    const parts=t.split(/\s+/).filter(Boolean);
    if(!parts.length) return "";
    const last=parts[parts.length-1].toLowerCase().replace(/[.,;:]+$/g,"");
    if(this.yasakSonKelimeler.includes(last)) parts.pop();
    return parts.join(" ").trim();
  }

  // ✅ yönetici standardı: adet/paket kısa isimde yazma (genel kural)
  removeQuantity(t){
    if(!t) return "";
    return t
      .replace(/[, ]*\b\d{1,2}\s*(упаковк(и|а)?|уп\.?)\b/gi,"")
      .replace(/[, ]*\b\d{1,2}\s*шт\.?\b/gi,"")
      .replace(/[, ]*\b\d{1,2}\s*(pcs|pc)\b/gi,"")
      .replace(/[, ]*\b\d{1,2}\b\s*$/g,"")
      .replace(/\s+/g," ")
      .trim();
  }

  normalizeCase(t){
    if(!t) return "";
    t = t.replace(/\bДля\b/g,"для");
    if(!this.opts.sentenceCase) return t;
    const low=t.toLowerCase();
    return low.charAt(0).toUpperCase()+low.slice(1);
  }

  // --- Dönüşümler ---
  cogulTekilDonustur(t){
    for(const e of this.cogulIstisnalar) if(t.includes(e)) return t;
    for(const {pattern,replacement} of this.cogulTekilDonusumleri) t=t.replace(pattern,replacement);
    return t;
  }

  hedefKitleDonustur(t){
    this.hedefKitleDonusumleri.forEach(({pattern,replacement})=>{
      t=t.replace(pattern,replacement);
    });
    // aynı hedef kitle tekrarı varsa sadeleştir
    t=t.replace(/\bдля (женщин|мужчин|мальчиков|девочек)\b(?:\s+для \1\b)+/gi,"для $1");
    return t;
  }

  // --- Sıra düzeltme (genel) ---
  escapeRegExp(s){ return s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"); }

  findFirstProductIndex(t){
    const lower=t.toLowerCase();
    let best=-1;
    for(const p of this.urunTipleri){
      const i=lower.indexOf(p.toLowerCase());
      if(i!==-1 && (best===-1 || i<best)) best=i;
    }
    return best;
  }

  headToTail(head){
    for(const m of this.onOzellikMap){
      if(m.re.test(head)) return m.tail;
    }
    return null;
  }

  ozellikSiraDuzelt(t){
    if(!t || !this.opts.moveLeadingFeatures) return t;

    const idx=this.findFirstProductIndex(t);
    if(idx<=0) return t;

    const head=t.slice(0,idx).trim();
    const rest=t.slice(idx).trim();
    const tail=this.headToTail(head);
    if(!tail) return t;

    if(new RegExp(this.escapeRegExp(tail),"i").test(rest)) return rest;
    return (rest+" "+tail).replace(/\s+/g," ").trim();
  }

  // --- Kırpma ---
  karakterSinirla(t){
    const max=this.opts.maxLen;
    if(t.length<=max) return t;

    let n=t.substring(0,max);
    const a=n.lastIndexOf(" ");
    n=a>0 ? n.substring(0,a).trim() : n.trim();

    n=this.sonNoktalamaTemizle(n);
    n=this.sonYasakKelimeTemizle(n);
    n=this.sonNoktalamaTemizle(n);
    return n;
  }

  // ✅ ana fonksiyon
  duzenle(input){
    if(!input || String(input).trim()==="") return "";

    let t=String(input).trim();
    t=this.noktalamaTemizle(t);
    t=this.boslukDuzelt(t);

    t=this.cogulTekilDonustur(t);
    t=this.hedefKitleDonustur(t);

    t=this.ozellikSiraDuzelt(t);

    // ✅ genel kural: kısa isimde adet yok
    if(!this.opts.includeQuantity){
      t=this.removeQuantity(t);
    }

    t=this.boslukDuzelt(t);
    t=this.karakterSinirla(t);

    // final güvenlik
    t=this.sonNoktalamaTemizle(t);
    t=this.sonYasakKelimeTemizle(t);
    t=this.sonNoktalamaTemizle(t);

    t=this.normalizeCase(t);
    return t;
  }
}
