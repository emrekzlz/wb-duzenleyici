<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WB Kurallı Düzenleyici (Silmeden Düzenle)</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        body { font-family: sans-serif; background: #f0f4f8; padding: 30px; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 40px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #2c3e50; }
        .box { border: 2px dashed #bdc3c7; padding: 40px; text-align: center; margin: 20px 0; cursor: pointer; background: #ecf0f1; }
        .box:hover { border-color: #3498db; background: #e8f4fc; }
        .btn { display: block; width: 100%; padding: 15px; background: #27ae60; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin-top: 20px; }
        .btn:hover { background: #219150; }
        #preview { margin-top: 20px; width: 100%; border-collapse: collapse; }
        #preview th, #preview td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #preview th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<div class="container">
    <h1>WB Kurallı Düzenleyici</h1>
    <p>Kurallar: Silmek yok, Gramer düzeltme var, Sıralama var (Kategori + Özellik + Hedef Kitle)</p>

    <div class="box" id="uploadBox">
        <h3>Excel Dosyasını Buraya Sürükle</h3>
    </div>
    
    <div id="status"></div>
    <button id="downloadBtn" class="btn" style="display:none;">Düzenlenmiş Dosyayı İndir</button>
    <table id="preview"></table>
</div>

<script>
class WBEditor {
    constructor() {
        // 1. Ürün Sözlüğü (Çoğul -> Tekil Kuralları)
        this.productMap = {
            // HATA OLANLAR (Düzeltilecekler)
            'футболки': 'Футболка', 'футболка': 'Футболка',
            'рубашки': 'Рубашка', 'рубашка': 'Рубашка',
            'блузки': 'Блузка', 'блузка': 'Блузка',
            'платья': 'Платье', 'платье': 'Платье',
            'костюмы': 'Костюм', 'костюм': 'Костюм',
            'свитера': 'Свитер', 'свитер': 'Свитер',
            'толстовки': 'Толстовка', 'толстовка': 'Толстовка',
            'свитшоты': 'Свитшот', 'свитшот': 'Свитшот',
            'майки': 'Майка', 'майка': 'Майка',
            'пижамы': 'Пижама', 'пижама': 'Пижама',
            'куртки': 'Куртка', 'куртка': 'Куртка',
            'жилеты': 'Жилет', 'жилет': 'Жилет',
            'комбинезоны': 'Комбинезон', 'комбинезон': 'Комбинезон',
            'кардиганы': 'Кардиган', 'кардиган': 'Кардиган',
            'туники': 'Туника', 'туника': 'Туника',
            'боди': 'Боди', 'пальто': 'Пальто',
            // DOĞAL ÇOĞULLAR (Dokunulmayacaklar)
            'брюки': 'Брюки', 'шорты': 'Шорты', 'джинсы': 'Джинсы', 
            'леггинсы': 'Леггинсы', 'лосины': 'Лосины', 'трусы': 'Трусы',
            'джоггеры': 'Джоггеры', 'бриджи': 'Бриджи'
        };

        // 2. Hedef Kitle Regexleri
        this.targets = [
            { r: /женщин[аы]/i, v: 'для женщин' },
            { r: /мужчин[аы]/i, v: 'для мужчин' },
            { r: /девоч[а-я]*|для девочек/i, v: 'для девочек' },
            { r: /мальчи[а-я]*|для мальчиков/i, v: 'для мальчиков' },
            { r: /детск[а-я]*|для детей/i, v: 'для детей' },
            { r: /малыш[а-я]*|для малышей/i, v: 'для малышей' },
            { r: /беременн[а-я]*/i, v: 'для беременных' }
        ];
    }

    duzenle(baslik) {
        if (!baslik) return "";
        let ham = String(baslik)
            .replace(/[:;,]/g, " ") // Kural 3: İki nokta ve virgül yasak
            .replace(/\s+/g, " ")   // Fazla boşlukları sil
            .trim();

        let kelimeler = ham.split(" ");
        let urunAdi = "";
        let hedefKitle = "";
        let ozellikler = [];

        // KELİME ANALİZİ
        kelimeler.forEach(kelime => {
            let kucuk = kelime.toLowerCase();
            let temizKucuk = kucuk.replace(/[.,]/g, ""); // Noktalama temizle

            // A. Hedef Kitle mi?
            let kitleBulundu = false;
            for (let t of this.targets) {
                if (t.r.test(kucuk)) {
                    hedefKitle = t.v; // Standart formatı al (Kural 5: Net belirtilmeli)
                    kitleBulundu = true;
                    break;
                }
            }
            if (kitleBulundu) return;

            // B. Ürün Adı mı? (Kural 13: Tekil/Çoğul Düzeltmesi)
            // Kelimenin köküne bak (basitçe) veya tam eşleşme ara
            let sozlukKarsiligi = this.productMap[temizKucuk];
            
            // Eğer sözlükte varsa ve henüz ürün adı bulmadıysak
            if (sozlukKarsiligi) {
                if (!urunAdi) {
                    urunAdi = sozlukKarsiligi; // Doğru gramerli halini al
                    return;
                }
            }

            // C. Hiçbiri değilse Özelliktir (Sıfat, Detay)
            // Sadece anlamsız tek harfleri veya sayıları alırken dikkat et
            if (kucuk.length > 1 || /\d/.test(kucuk)) {
                // Kural 8: Yarım kalan ifadeleri düzelt (Bağlaç kontrolü sonra yapılacak)
                ozellikler.push(kelime); // Orijinal halini sakla (Büyük/küçük harf bozulmasın diye)
            }
        });

        // İNŞA ETME (Kural 4: Kategori / Ürün Başlığı olacak)
        // Sıralama: [ÜRÜN] [ÖZELLİKLER] [HEDEF KİTLE]
        
        let yeniBaslikParcalari = [];

        // 1. Ürün Adı (En Başa)
        if (urunAdi) {
            yeniBaslikParcalari.push(urunAdi);
        } else if (ozellikler.length > 0) {
            // Ürün adı bulamadıysak özelliklerin ilkini baş yap
            let ilk = ozellikler.shift();
            yeniBaslikParcalari.push(ilk.charAt(0).toUpperCase() + ilk.slice(1));
        }

        // 2. Özellikler
        // Bağlaç temizliği: Eğer özellik listesinde 'с' (ile) var ama arkasından kelime gelmiyorsa sil
        let temizOzellikler = [];
        for (let i = 0; i < ozellikler.length; i++) {
            let kelime = ozellikler[i];
            // Sarkan bağlaçları temizle (Kural 8: Anlam bütünlüğü)
            if (['с', 'и', 'из'].includes(kelime.toLowerCase()) && i === ozellikler.length - 1) {
                continue; 
            }
            temizOzellikler.push(kelime.toLowerCase()); // Özellikler küçük harf
        }
        yeniBaslikParcalari.push(...temizOzellikler);

        // 3. Hedef Kitle (En Sona)
        if (hedefKitle) {
            yeniBaslikParcalari.push(hedefKitle);
        }

        let sonuc = yeniBaslikParcalari.join(" ");

        // SON RÖTUŞLAR
        // Kural 12: Büyük-küçük harf düzgün olacak (Cümle başı büyük)
        sonuc = sonuc.charAt(0).toUpperCase() + sonuc.slice(1);

        // Kural 7: Maksimum 60 Karakter
        if (sonuc.length > 60) {
            // Kelimeyi ortadan bölmemek için son boşluktan kes
            let kesik = sonuc.substring(0, 60);
            let sonBosluk = kesik.lastIndexOf(" ");
            if (sonBosluk > 0) {
                sonuc = kesik.substring(0, sonBosluk);
            } else {
                sonuc = kesik;
            }
        }

        return sonuc.trim();
    }
}

// --- Dosya İşleme Kodları ---
const editor = new WBEditor();
const uploadBox = document.getElementById('uploadBox');
const fileInput = document.createElement('input');
fileInput.type = 'file'; fileInput.accept = '.xlsx, .xls';

uploadBox.onclick = () => fileInput.click();
uploadBox.ondragover = (e) => { e.preventDefault(); uploadBox.style.borderColor = '#3498db'; };
uploadBox.ondragleave = () => { uploadBox.style.borderColor = '#bdc3c7'; };
uploadBox.ondrop = (e) => { e.preventDefault(); if(e.dataTransfer.files[0]) processFile(e.dataTransfer.files[0]); };
fileInput.onchange = (e) => { if(e.target.files[0]) processFile(e.target.files[0]); };

let processedWorkbook = null;

function processFile(file) {
    document.getElementById('status').innerText = "İşleniyor...";
    const reader = new FileReader();
    reader.onload = (e) => {
        const data = new Uint8Array(e.target.result);
        const wb = XLSX.read(data, {type: 'array'});
        const ws = wb.Sheets[wb.SheetNames[0]];
        const json = XLSX.utils.sheet_to_json(ws, {header: 1});

        const headers = json[0];
        // İsim sütununu bul
        let colIdx = headers.findIndex(h => h && /name|isim|название/i.test(h));
        if (colIdx === -1) colIdx = 0;

        const outputData = [ [...headers, "WB_Final_Baslik"] ];

        // İlk 20 satırı önizleme için tut
        let previewHtml = "<thead><tr><th>Orjinal</th><th>Düzenlenmiş</th></tr></thead><tbody>";

        for (let i = 1; i < json.length; i++) {
            let row = json[i];
            let orjinal = row[colIdx];
            let yeni = editor.duzenle(orjinal);
            
            let newRow = [...row];
            newRow.push(yeni);
            outputData.push(newRow);

            if (i < 11) {
                previewHtml += `<tr><td>${orjinal || ''}</td><td style="font-weight:bold; color:#27ae60;">${yeni}</td></tr>`;
            }
        }
        previewHtml += "</tbody>";
        document.getElementById('preview').innerHTML = previewHtml;

        // İndirme Hazırla
        const newWs = XLSX.utils.aoa_to_sheet(outputData);
        processedWorkbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(processedWorkbook, newWs, "Sonuclar");
        
        document.getElementById('downloadBtn').style.display = "block";
        document.getElementById('status').innerText = "✅ Tamamlandı";
    };
    reader.readAsArrayBuffer(file);
}

document.getElementById('downloadBtn').onclick = () => {
    XLSX.writeFile(processedWorkbook, "WB_Kuralli_Duzenlenmis.xlsx");
};
</script>

</body>
</html>
